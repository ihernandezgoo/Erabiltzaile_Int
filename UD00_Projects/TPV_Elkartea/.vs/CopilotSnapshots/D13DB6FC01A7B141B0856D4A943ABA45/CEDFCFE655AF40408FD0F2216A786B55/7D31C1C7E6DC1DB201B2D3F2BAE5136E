using System;
using System.Collections.Generic;
using System.IO;
using System.Text.Json;
using System.Windows;

namespace TPV_WPF
{
    public class Producto
    {
        public int Id { get; set; }
        public string Nombre { get; set; }
        public double Precio { get; set; }
    }

    public class ProductosCategoria
    {
        public List<Producto> Comida { get; set; }
        public List<Producto> Bebida { get; set; }
    }

    public partial class MainWindow : Window
    {
        ProductosCategoria categorias;
        List<(Producto producto, int cantidad)> carrito = new();

        public MainWindow()
        {
            InitializeComponent();
            CargarProductos();
            cbCategoria.SelectedIndex = 0;
        }

        private void CargarProductos()
        {
            string json = File.ReadAllText("productos.json");
            categorias = JsonSerializer.Deserialize<ProductosCategoria>(json);
        }

        private void CbCategoria_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            lbProductos.Items.Clear();
            List<Producto> lista = cbCategoria.SelectedIndex == 0 ? categorias.Comida : categorias.Bebida;
            foreach (var p in lista) lbProductos.Items.Add(p);
        }

        private void BtnAgregar_Click(object sender, RoutedEventArgs e)
        {
            if (lbProductos.SelectedItem == null) return;

            Producto producto = (Producto)lbProductos.SelectedItem;
            if (!int.TryParse(tbCantidad.Text, out int cantidad) || cantidad <= 0)
            {
                MessageBox.Show("Cantidad inválida");
                return;
            }

            carrito.Add((producto, cantidad));
            ActualizarCarrito();
        }

        private void ActualizarCarrito()
        {
            lbCarrito.Items.Clear();
            double subtotal = 0;
            foreach (var item in carrito)
            {
                double itemTotal = item.producto.Precio * item.cantidad;
                subtotal += itemTotal;
                lbCarrito.Items.Add(new { Descripcion = $"{item.cantidad} x {item.producto.Nombre} - ${itemTotal:F2}" });
            }
            double iva = subtotal * 0.21;
            double total = subtotal + iva;
            tbTotal.Text = $"Subtotal: ${subtotal:F2}  |  IVA 21%: ${iva:F2}  |  TOTAL: ${total:F2}";
        }

        private void BtnTicket_Click(object sender, RoutedEventArgs e)
        {
            if (carrito.Count == 0)
            {
                MessageBox.Show("Carrito vacío");
                return;
            }

            string ticket = "=== TICKET ===\n";
            double subtotal = 0;
            foreach (var item in carrito)
            {
                double itemTotal = item.producto.Precio * item.cantidad;
                subtotal += itemTotal;
                ticket += $"{item.cantidad} x {item.producto.Nombre} - ${itemTotal:F2}\n";
            }
            double iva = subtotal * 0.21;
            double total = subtotal + iva;
            ticket += $"Subtotal: ${subtotal:F2}\nIVA 21%: ${iva:F2}\nTOTAL: ${total:F2}";
            MessageBox.Show(ticket, "Ticket");
        }

        private void BtnCalcularIMC_Click(object sender, RoutedEventArgs e)
        {
            if (!double.TryParse(tbPeso.Text, out double peso) || !double.TryParse(tbAltura.Text, out double altura) || altura <= 0)
            {
                MessageBox.Show("Valores inválidos");
                return;
            }

            double imc = peso / (altura * altura);
            string estado = imc < 18.5 ? "Bajo peso" :
                            imc < 25 ? "Peso normal" :
                            imc < 30 ? "Sobrepeso" : "Obesidad";

            tbIMC.Text = $"IMC: {imc:F2} ({estado})";
        }
    }
}